# 비동기 프로그래밍
## 동기 처리와 비동기 처리

### 동기 처리
자바스크립트 엔진은 한번에 하나의 태스크만 처리할 수 있는 싱글 스레드 방식으로 동작한다. 그래서 시간이 걸리는 태스크를 수행할 경우 그 뒤의 태스크가 작업 중단되고 대기한다.

```javascript
function sleep(func, delay) {
    const delayUntil = Date.now() + delay;

    while(Date.now() < delayUntil);
    func();
}

function foo(){
    console.log('foo');
}

function bar(){
    console.log('bar');
}

sleep(foo, 3 * 1000)

bar();

// 3초 경과 후
// foo
// bar
```

이 예제의 sleep 함수는 3초 뒤에 foo 함수를 호출한 뒤에 bar 함수를 호출한다. 이때 bar 함수는 3초 이상의 시간 동안 수행되지 못하고 블로킹되어 있는데, 이처럼 **순차적으로 수행하도록 다음에 실행할 태스크가 대기하는 방식**을 `동기 처리 방식`이라고 한다.

### 비동기 처리

```javascript
function foo(){
    console.log('foo');
}

function bar(){
    console.log('bar');
}

setTimeout(foo, 3 * 1000);
bar();

// bar 
// 3초 경과 후
// foo
```
반대로 이처럼 현재 실행 중인 태스크가 종료되지 않은 상태라고 해도 **다음 태스크를 바로 실행하는 방식**을 `비동기 처리 방식`이라고 한다.

## 이벤트 루프와 태스크 큐
 자바스크립트 엔진은 싱글 스레드 방식으로 동작하지만 브라우저가 동작하는 걸 지켜보면 여러가지 태스크를 한번에 수행하는 것처럼 느껴진다. 이같은 자바스크립트의 동시성을 지원하는 것이 `이벤트 루프`다. 

자바스크립트 엔진은 크게 2가지의 영역으로 구분할 수 있다.
 - **call stack:** 실행 컨택스트 스택.
 - **heap:** 객체가 저장되는 메모리 공간인 힙은 구조화되어있지 않다는 특징이 있다. 객체는 원시값과 달리 크기가 정해져 있지 않아서 할당해야 할 메모리 공간의 크기를 런타임에 결정(동적 할당)해야한다.

 콜 스택과 힙으로 구성되어 있는 자바스크립트 엔진은 태스크가 들어오면 **순차적으로 실행할 뿐**이다. `비동기 처리에서의 소스코드의 평가와 실행은 엔진을 구동하는 환경인 브라우저나 Node.js가 담당한다.`

 - **task queue:** 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역이다. 
 - **event loop:** 콜 스택에 현재 실행되고 있는 실행 컨텍스트가 있는지 + 태스크 큐에 대기 중인 함수가 있는지 반복적으로 확인하고 콜 스택이 비었다면 순차적으로 태스크 큐 => 콜 스택으로 이동시킨다.

다음 예제로 비동기 처리에서 delay가 0초로 지정되었을 때 어떤 함수가 먼저 실행될지를 알아보자.
```javascript
function foo(){
    console.log('foo');
}

function bar(){
    console.log('bar');
}

setTimeout(foo, 0);
bar();

// bar 
// 0초 경과 후 (실제는 4ms 후)
// foo
```

1. 전역 코드가 평가되어 전역 실행 컨텍스트가 생성되고 콜 스택에 푸시된다.
2. 전역 코드가 실행되며 setTimeout 함수 호출 -> 콜 스택에 푸시된다.
3. setTimeout 함수가 실행되면 콜백 함수를 호출 스케줄링하고 종료되어 콜 스택에서 pop.
4. 브라우저가 수행: 4-1, 자바스크립트 엔진이 수행: 4-2는 병행 처리된다.
- 4-1. 브라우저는 타이머 만료시 콜백 함수를 태스크 큐로 푸시되기에 위 예제에서는 최소 지연시간 4ms 후 태스크 큐로 foo가 푸시되고 대기하게 된다.
- 4-2. bar 함수가 호출되어 bar의 실행 컨텍스트가 생성되고, 콜 스택에 푸시되어 현재 실행 중인 실행 컨텍스트가 된다. (4ms가 경과했다면 foo 대기중)
5. 전역 코드 실행이 종료되고 전역 실행 컨텍스트가 pop되어 콜 스택이 비게 된다.
6. 대기 중이던 foo 함수가 이벤트 루프에 의해 빈 콜 스택에 푸시된다. foo 함수가 종료된 후 콜 스택에서 pop

**=> 자바스크립트 엔진은 싱글 스레드 방식으로 동작하지만 브라우저는 멀티 스레드 방식으로 동작한다.**